"""
This is a WLST script that is generated by the WebLogic Scripting Tool (WLST)
Configuration file converted               : {{ mw_installer_folder }}/cusdomain/config/config.xml
WLST script generated to file              : {{ mw_installer_folder }}/config.py
Properties file associated with the script : {{ mw_installer_folder }}/config.py.properties

This script will first try to connect to a running server using the 
values in the properties file. If there is no server running, WLST
will start a server with the values in the properties file. You should change
these values to suit your environmental needs. After running the script, 
the server that is started(if started one) will be shutdown. 
This might exit you from your WLST shell."""

from weblogic.descriptor import BeanAlreadyExistsException
from java.lang.reflect import UndeclaredThrowableException
from java.lang import System
import javax
from javax import management
from javax.management import MBeanException
from javax.management import RuntimeMBeanException
import javax.management.MBeanException
from java.lang import UnsupportedOperationException

domain_application_home = '{{ applications_home }}/{{ domain_name }}'
domain_configuration_home = '{{ domain_home }}'
domain_name = '{{ domain_name }}'
java_home = '{{ jdk_folder }}'
middleware_home = '{{ middleware_home }}'
node_manager_home = '{{ nodemanager_home }}'
weblogic_home = '{{ weblogic_home }}'


weblogic_template=weblogic_home + '/common/templates/domains/wls.jar';

def createBaseDomain():
  readTemplate(weblogic_template);
  setOption('DomainName', domain_name);
  setOption('OverwriteDomain', 'true');
  setOption('JavaHome', java_home);
  setOption('ServerStartMode', 'prod');
  #setOption('NodeManagerType', 'CustomLocationNodeManager');
  #setOption('NodeManagerHome', node_manager_home);
  cd('/Security/base_domain/User/weblogic');
  cmo.setName('weblogic');
  cmo.setUserPassword('welcome1');
  cd('/');
  cd('/Servers/AdminServer')
  theServer = cmo

  theServer.setName('cusadmin')
  theServer.setListenAddress('cusadmin')
  theServer.setListenPort(9101)

  print "SAVE DOMAIN";
  writeDomain(domain_configuration_home);
  closeTemplate();

  print 'READ DOMAIN';
  readDomain(domain_configuration_home);


  cd("/SecurityConfiguration/" + domain_name);
  cmo.setNodeManagerUsername('weblogic');
  cmo.setNodeManagerPasswordEncrypted('welcome1');

  #cd('/Server/' + 'AdminServer');
  #create('AdminServer','SSL');
  #cd('SSL/' + 'AdminServer');
  #cmo.setHostnameVerificationIgnored(true);
  #cmo.setHostnameVerifier(None);
  #cmo.setTwoWaySSLEnabled(false);
  #cmo.setClientCertificateEnforced(false);

  #cd('/SecurityConfiguration/'+ domain_name +'/Realms/myrealm');
  #cd('AuthenticationProviders/DefaultAuthenticator');
  #set('ControlFlag', 'SUFFICIENT');
  #cd('../../');

  updateDomain();
  closeDomain();
  




def initConfigToScriptRun():
  global startedNewServer
  loadProperties("{{ mw_installer_folder }}/config.py.properties")
  hideDisplay()
  hideDumpStack("true")
  # try connecting to a running server if it is already running ... 
  if connected=="false":
    try:
      URL="t3://"+adminServerListenAddress+":"+adminServerListenPort
      connect(userName, passWord, URL, userConfigFile="{{ mw_installer_folder }}/c2sConfigcusdomain", userKeyFile="{{ mw_installer_folder }}/c2sSecretcusdomain")
    except WLSTException:
      print 'No server is running at '+URL+', the script will start a new server'
  hideDumpStack("false")
  if connected=="false":
    print 'Starting a brand new server at '+URL+' with server name '+adminServerName
    print 'Please see the server log files for startup messages available at '+domainDir
    # If a config.xml exists in the domainDir, WLST will use that config.xml to bring up the server. 
    # If you would like WLST to overwrite this directory, you should specify overWriteRootDir='true' as shown below
    # startServer(adminServerName, domName, URL, userName, passWord,domainDir, overWriteRootDir='true')
    _timeOut = Integer(TimeOut)
    # If you want to specify additional JVM arguments, set them using startServerJvmArgs in the property file or below
    _startServerJvmArgs=startServerJvmArgs
    if (_startServerJvmArgs=="" and (System.getProperty("java.vendor").find("Sun")>=0 or System.getProperty("java.vendor").find("Hewlett")>=0)):
      _startServerJvmArgs = " -XX:MaxPermSize=128m"
    if overWriteRootDir=='true':
      startServer(adminServerName, domName, URL, userName, passWord,domainDir, timeout=_timeOut.intValue(), overWriteRootDir='true', block='true', jvmArgs=_startServerJvmArgs)
    else:
      startServer(adminServerName, domName, URL, userName, passWord,domainDir, timeout=_timeOut.intValue(), block='true', jvmArgs=_startServerJvmArgs)
    startedNewServer=1
    print "Started Server. Trying to connect to the server ... "
    connect(userName, passWord, URL, userConfigFile="{{ mw_installer_folder }}/c2sConfigcusdomain", userKeyFile="{{ mw_installer_folder }}/c2sSecretcusdomain")
    if connected=='false':
      stopExecution('You need to be connected.')

def storeUserConfigKey():
  storeUserConfig('{{ mw_installer_folder }}/c2sConfigcusdomain','{{ mw_installer_folder }}/c2sSecretcusdomain')

def startTransaction():
  edit()
  startEdit()

def endTransaction():
  startEdit()
  save()
  activate(block="true")

from javax.management import InstanceAlreadyExistsException
from java.lang import Exception
from jarray import array

def endOfConfigToScriptRun():
  global startedNewServer
  #Save the changes you have made
  # shutdown the server you have started
  if startedNewServer==1:
    print 'Shutting down the server that is started... '
    shutdown(force='true', block='true')
  print 'Done executing the script.'

def create_Server_0(path, beanName):
  cd(path)
  try:
    print "creating mbean of type Server ... "
    theBean = cmo.lookupServer(beanName)
    if theBean == None:
      cmo.createServer(beanName)
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_Realm_2(path, beanName):
  cd(path)
  try:
    print "creating mbean of type Realm ... "
    theBean = cmo.lookupRealm(beanName)
    if theBean == None:
      cmo.createRealm(beanName)
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_Authorizer_4(path, beanName):
  cd(path)
  try:
    print "creating mbean of type Authorizer ... "
    theBean = cmo.lookupAuthorizer(beanName)
    if theBean == None:
      cmo.createAuthorizer(beanName,"weblogic.security.providers.xacml.authorization.XACMLAuthorizer")
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_Adjudicator_6(path, beanName):
  cd(path)
  try:
    print "creating mbean of type Adjudicator ... "
    theBean = cmo.getAdjudicator()
    if theBean == None:
      cmo.createAdjudicator(beanName,"weblogic.security.providers.authorization.DefaultAdjudicator")
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_AuthenticationProvider_8(path, beanName):
  cd(path)
  try:
    print "creating mbean of type AuthenticationProvider ... "
    theBean = cmo.lookupAuthenticationProvider(beanName)
    if theBean == None:
      cmo.createAuthenticationProvider(beanName,"weblogic.security.providers.authentication.DefaultAuthenticator")
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_CertPathProvider_12(path, beanName):
  cd(path)
  try:
    print "creating mbean of type CertPathProvider ... "
    theBean = cmo.lookupCertPathProvider(beanName)
    if theBean == None:
      cmo.createCertPathProvider(beanName,"weblogic.security.providers.pk.WebLogicCertPathProvider")
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_CredentialMapper_14(path, beanName):
  cd(path)
  try:
    print "creating mbean of type CredentialMapper ... "
    theBean = cmo.lookupCredentialMapper(beanName)
    if theBean == None:
      cmo.createCredentialMapper(beanName,"weblogic.security.providers.credentials.DefaultCredentialMapper")
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def create_RoleMapper_16(path, beanName):
  cd(path)
  try:
    print "creating mbean of type RoleMapper ... "
    theBean = cmo.lookupRoleMapper(beanName)
    if theBean == None:
      cmo.createRoleMapper(beanName,"weblogic.security.providers.xacml.authorization.XACMLRoleMapper")
  except java.lang.UnsupportedOperationException, usoe:
    pass
  except weblogic.descriptor.BeanAlreadyExistsException,bae:
    pass
  except java.lang.reflect.UndeclaredThrowableException,udt:
    pass

def setAttributes_SecurityConfiguration_18():
  cd("/SecurityConfiguration/cusdomain")
  print "setting attributes for mbean type SecurityConfiguration"
  setEncrypted("Credential", "c2s19", "{{ mw_installer_folder }}/c2sConfigcusdomain", "{{ mw_installer_folder }}/c2sSecretcusdomain")
  setEncrypted("NodeManagerPassword", "c2s20", "{{ mw_installer_folder }}/c2sConfigcusdomain", "{{ mw_installer_folder }}/c2sSecretcusdomain")
  setEncrypted("NodeManagerPassword", "c2s21", "{{ mw_installer_folder }}/c2sConfigcusdomain", "{{ mw_installer_folder }}/c2sSecretcusdomain")
  set("NodeManagerUsername", "weblogic")
  setEncrypted("Credential", "c2s22", "{{ mw_installer_folder }}/c2sConfigcusdomain", "{{ mw_installer_folder }}/c2sSecretcusdomain")

def setAttributesFor_DefaultIdentityAsserter_11():
  cd("/SecurityConfiguration/cusdomain/Realms/myrealm/AuthenticationProviders/DefaultIdentityAsserter")
  print "setting attributes for mbean type DefaultIdentityAsserter"
  set("ActiveTypes", jarray.array(["AuthenticatedUser"], String))

def setAttributes_EmbeddedLDAP_23():
  cd("/EmbeddedLDAP/cusdomain")
  print "setting attributes for mbean type EmbeddedLDAP"
  setEncrypted("Credential", "c2s24", "{{ mw_installer_folder }}/c2sConfigcusdomain", "{{ mw_installer_folder }}/c2sSecretcusdomain")
  setEncrypted("Credential", "c2s25", "{{ mw_installer_folder }}/c2sConfigcusdomain", "{{ mw_installer_folder }}/c2sSecretcusdomain")

def setAttributes_Domain_26():
  cd("/")
  print "setting attributes for mbean type Domain"
  set("DomainVersion", "10.3.4.0")
  set("ProductionModeEnabled", "true")
  set("ConfigurationVersion", "10.3.4.0")
  set("AdminServerName", "cusadmin")

def setAttributes_SSL_27():
  cd("/Servers/cusadmin/SSL/cusadmin")
  print "setting attributes for mbean type SSL"
  set("Enabled", "false")
  set("ListenPort", "7002")
  set("HostnameVerificationIgnored", "true")

def setAttributesFor_cusadmin_1():
  cd("/Servers/cusadmin")
  print "setting attributes for mbean type Server"
  set("ListenPort", "9101")
  set("JavaCompiler", "javac")
  set("ListenPortEnabled", "true")
  set("ListenAddress", "cusadmin")
  set("ClientCertProxyEnabled", "false")

try:
  createBaseDomain() 
  initConfigToScriptRun()
 # storeUserConfigKey()
  startTransaction()
  create_Server_0("/", "cusadmin")
  create_Realm_2("/SecurityConfiguration/cusdomain", "myrealm")
  create_Authorizer_4("/SecurityConfiguration/cusdomain/Realms/myrealm", "XACMLAuthorizer")
  create_Adjudicator_6("/SecurityConfiguration/cusdomain/Realms/myrealm", "DefaultAdjudicator")
  create_AuthenticationProvider_8("/SecurityConfiguration/cusdomain/Realms/myrealm", "DefaultAuthenticator")
  create_AuthenticationProvider_8("/SecurityConfiguration/cusdomain/Realms/myrealm", "DefaultIdentityAsserter")
  create_CertPathProvider_12("/SecurityConfiguration/cusdomain/Realms/myrealm", "WebLogicCertPathProvider")
  create_CredentialMapper_14("/SecurityConfiguration/cusdomain/Realms/myrealm", "DefaultCredentialMapper")
  create_RoleMapper_16("/SecurityConfiguration/cusdomain/Realms/myrealm", "XACMLRoleMapper")
  setAttributesFor_cusadmin_1()
  setAttributesFor_DefaultIdentityAsserter_11()
  setAttributes_SecurityConfiguration_18()
  setAttributes_EmbeddedLDAP_23()
  setAttributes_Domain_26()
  setAttributes_SSL_27()
  endTransaction()
finally:
  endOfConfigToScriptRun()
